<html>
<head>
	<title>Landing</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
	  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<!-- <style> 
		.row {
			padding: 12px;
		}  
		.center-align > p {
			font-size: 180%; 
		}
		.game_div {
			padding: 3px;
		}
		.game_div > p {
			margin: 4px;
		}
		.player {
			font-size: 70%;
		}
		.header {
			display: inline;
		}
		.material-icons{
			float: right;	
		}
		#current_user {
			padding-right: 0px;
		}
		.btn-small {
			float: right;
			height: 24px;
		    line-height: 24px;
		    padding: 0 0.5rem;
		}
	</style> -->
	<style type="text/css">
		.main {
			width: 60%;
			margin-left: auto;
			margin-right: auto;
		}
		.auth {
			width: 250px;
			margin-left: auto;
			margin-right: auto;
		}

		#sign-in {
			margin-left: 60px;
		}
	</style>
</head>
<body>
<!-- <div class="container red lighten-3">
		<div class="row" style="margin: 0px">
			<div class="col s3">
				<div class="blue game_div z-depth-3">
					<h5>Cool People Only</h5>
					<p style=>Current Players:</p>
					<p class="player">MilkMan24</p>
					<p class="player">LuckyGuy13</p>
					<p class="player">JoeShmoe</p>
					<p class="player">Erik</p>
				</div>
				
			</div>
			<div class="col s3">
				<div class="blue game_div z-depth-2">
					<h5>Cool People Suck</h5>
					<p style="font-size: 125%">Current Players:</p>
					<p class="player">MilkMan22</p>
				</div>
				
			</div>
			<div class="col s3">
				<div class="blue game_div">
					<h5>Henry's Lobby</h5>
					<p style="font-size: 125%">Current Players:</p>
					<p class="player">HenryTheHenry</p>
					<p class="player">NotHenry</p>
					<p class="player">StillNotHenry</p>
					<p class="player">Erik</p>
					<p class="player">Guy123</p>
				</div>
			</div>
			<div class="col s3">
				<div class="blue game_div">
					<h5>Cool People Only</h5>
					<p style="font-size: 125%">Current Players:</p>
					<p class="player">MilkMan24</p>
					<p class="player">LuckyGuy13</p>
				</div>
				
			</div>	
		</div>

		<div class="row">
			<a class="waves-effect waves-light btn green accent-3">Create Lobby</a>
		</div>
		<div class="row">
			<div id="player_bank" class="col s4 offset-s1 yellow">
				<h5>In Main Lobby</h5>
				<div id="players"></div>
			</div>
			<div id="current_user" class="col s5 offset-s1 light-green accent-1">
		       <form class="form">
		          <div class="row" style="margin: 0px">
		             <div class="input-field col s6">
		                <input placeholder="Username" id="user_name" type="text" class="validate">
		          	 </div>
		          	 <div class="input-field col s6">
		            	<input  placeholder="Password" id="user_pass" type="text" class="validate">
		          	 </div>
		          </div>
		          <a id="sign-in" class="waves-effect waves-dark btn green accent-3">Register</a>
		       </form>
			</div>
		</div>
	</div>-->      
	<div class="container">
		<div class="main center blue">
			<br><h3>Prop Game</h3><br>
			<div>
				<a id="button_create" class="waves-effect red waves-light btn-large">Create Lobby</a>
				<br><br>
				<a id="button_join" class="waves-effect red waves-light btn-large">Join</a>
			</div>
			<br>
		</div>
		<br>
		<div class="auth">
	       <form class="form">
	          	<div class="row" style="margin: 0px">
	              <div class="input-field col s12">
	              	<input placeholder="display name" id="name" type="text" class="validate">
	          	  </div>
	          	  <div class="input-field col s12 pass">
	              	<input placeholder="lobby password" id="lobby_password" type="text" class="validate">
	          	  </div>
	          	</div>
	          	<p>
      			  <input name="group1" type="checkbox" id="game_type"/>
      			  <label for="game_type">Private Game?</label>
    			</p>
			    <button id="sign-in" class="btn waves-effect waves-light" type="submit" name="action">Submit</button>
	       </form>
		</div>
		
		<div class="lobby green">
			<h4>Lobbies</h4>
			<div class="lobbies_container">
				<p>lobbies display here from firebase</p>
			</div>
		</div>
	</div>


	<script src="https://code.jquery.com/jquery.js"></script>		
	<script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>

	<script type="text/javascript">
		var config = {
		    apiKey: "AIzaSyAJoEFrLqa_WPI4S6SeVRsVdPBlAAbZ5Eg",
		    authDomain: "buy-game-d14de.firebaseapp.com",
		    databaseURL: "https://buy-game-d14de.firebaseio.com",
		    projectId: "buy-game-d14de",
		    storageBucket: "buy-game-d14de.appspot.com",
		    messagingSenderId: "356316304251"
		};
	  	firebase.initializeApp(config);
	  	var database = firebase.database(),
	  		isPrivate = false,
	  		lobbies = [];

	  	database.ref('users/').on('value', function(data) {
		  	console.log(data.val());
		  	var dbUsers = data.val().users;
			
		  	if(dbUsers === undefined) dbUsers = [];
	  	});

	  	database.ref('lobbies/').on('value', function(data) {
		  	// console.log(data.val());

			var dbLobby = data.val();
			
		  	if(dbLobby === undefined) {
		  		dbLobby = [];
	  		} else lobbies = dbLobby;
	  		console.log(lobbies);
	  		displayLobbies();
	  	});

		$('.auth').hide();
		$('.lobby').hide();
		$('.pass').hide();
		$('#button_create').on('click', function() {
			$('.auth').show();
		})

		$('#button_join').on('click', function() {
			displayLobbies();
			$('.lobby').show();
		})

		// toggle function for password input
		$('#game_type').on('click', function() {
			if(isPrivate) {
				isPrivate = false;
				$('.pass').hide();
			} else {
				isPrivate = true;
				$('.pass').show();
			}
			console.log(isPrivate);
		});

		$('form').on('submit', function(event) {
			event.preventDefault();
			var nameInput = $('#name').val().trim();
			var passInput = $('#lobby_password').val();
			
			var lobbyId = getId(nameInput.charAt(0));
			var tempArr = [nameInput];

			// sets new lobby to firebase
			database.ref('lobbies/' + lobbyId).set({
				host: nameInput,
				private: isPrivate,
				password: passInput,
				players: tempArr
			})
		});

		//creates string of random chars for firebase queries
		function getId(char) {
			var bank = "abcdefghijklmnopqrstuvwxyz123456789";
			var id = char;
			for(var i=0;i<6; i++) {
				var rando = Math.floor((Math.random() * bank.length));
				id += bank[rando];
			}
			return id
		}

		function displayLobbies() {
			console.log('hi')
			$('.lobbies_container').empty();
			for(var i=0; i<lobbies.length; i++) {
				console.log('yes');
			}
		}
	</script>


	<!-- <script>
	  function displayUsers(array) {
	  	$("#players").empty();

	  	$(array).each( function(i) {	
	  		var p = $("<p>");
	  		p.html(array[i]);
	  		$("#players").append(p);	
	  	});
	  } 	

	  function displayLobbies(array) {
	  	$("#lobbies").empty();
	  	var limit = Math.ceil(lobbies.length/4)

	  	for(var i=0; i<limit; i++) {
	  		var row = $("<div class='row'>");
	  		for(var x=0; x<4; x++) {
	  			var column = $("<div class='col s3'>");
	  			var gameDiv = $("<div class='game_div z-depth-2'>")
	  			var lobbyTitle = $("<h5>").html(array[i].title);
	  			
	  			gameDiv.append(lobbyTitle);

	  			for(var y=0; y<array[i].players.length; y++) {
	  				gameDiv.append( $("<p>").html(array[i].players[y]) );
	  			}
	  			column.append(gameDiv);
	  			row.append(column);
	  		}
	  	};

	  }

	  function noConnectionDisplay() {
	  	$("#players").empty();

	  	var txt = $("<p>");
	  	txt.html("Lost connection to database");
	  	$("#players").append(txt);
	  }

	  function checkStorage() {
	  	console.log(sessionStorage);
	  	if( typeof(sessionStorage.username) !== "undefined") displayAccount();
	  }

	  function getData(name, callBack) {
	  	database.ref('users/' + name).once('value').then(function(snapshot) {
	  		var obj = snapshot.val();
	  		callBack(obj);
	  	})
	  }

	  function signIn(name, pass) {
	  	/* two routes
	  		check if entered username is already in db
	  			if no, insert into user/pass into db

	  			if yes, check if user/pass is correct 
	  				then sign in append to online player 	*/

	  	getData(name, function(data) {
	  		console.log(data);

	  		if (data === null) firebaseSet(name, pass);
			else if(name === data.username && pass === data.password) {
	  			saveSession(data);
	  		} 
	  	});
	  }

	  // inserts new users to database with starting stats
	  function firebaseSet(name, pass) {
	  	database.ref('users/' + name).set({
	  	  username: name,
	  	  password: pass,
	  	  completed_games: 0,
	  	  games_won: 0
	  	});

	  	getData(name, function(data){
	  		saveSession(data);
	  	});  	
	  }

	  function displayAccount() {
	  	$(".form").hide();
	  	var user_box = $("<div id='user'>")

	  	var name = $("<h5 class='header'>").html(sessionStorage.username);
	  	var icon = $("<a class='btn-small btn'><i id='sign-out' class='material-icons header'>clear</i></a>");
	  	var totalGames = $("<p>").html("Games Completed: "  + sessionStorage.completed_games);
	  	var gamesWon = $("<p>").html("Games won: " + sessionStorage.games_won);

	  	[
	  		name,
	  		icon,
	  		totalGames,
	  		gamesWon
	  	].forEach(function(ele) {
	  		user_box.append(ele);
	  	});

	  	$("#current_user").append(user_box);
	  }

	  function saveSession(user) {
	  	sessionStorage.username = user.username;
	  	sessionStorage.completed_games = user.completed_games;
	  	sessionStorage.games_won = user.games_won; 

	  	players.push(user.username);
	  	database.ref('online_users').set(players);
	  	displayAccount();
	  }

	  $(document).ready(function() {
	  	$("#sign-in").on("click", function() {
	  		event.preventDefault();

	  		var userName = $("#user_name").val().trim();
	  		var userPass = $("#user_pass").val();
	  		// console.log(userName);

	  		signIn(userName, userPass);
	  	});

	  	$("#sign-out").on("click", function() {
	  		console.log(players);
	  		console.log("thing");
	  		var newArray = [];
	  		for(var i=0; i<players.length; i++) {
	  		  if(sessionStorage.username !== players[i]) {
	  		  	newArray[i] = players[i]
	  		  }
	  		}
	  		players = newArray;
	  		sessionStorage.removeItem("completed_games");
	  		sessionStorage.removeItem("games_won");
	  		sessionStorage.removeItem("username");

	  		database.ref('online_users').set(players);
	  		$("#user").empty();
	  		$(".form").show();
	  		displayUsers(players);
	  	});
	  });
	</script>	 -->

</body>
</html>