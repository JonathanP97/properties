<html>
<head>
	<title>Current Games</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/materialize/0.100.2/css/materialize.min.css">
	  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
	<style> 
		.row {
			padding: 12px;
		}  
		.center-align > p {
			font-size: 180%; 
		}
		.game_div {
			padding: 3px;
		}
		.game_div > p {
			margin: 4px;
		}
		.player {
			font-size: 70%;
		}
		.header {
			display: inline;
		}
		.material-icons{
			float: right;	
			background-color: grey;
		}
		#current_user {
			padding-right: 0px;
		}
	</style>
</head>
<body>
	<nav class="center-align">
		<p>Current Games</p>
	</nav>
	<br>
	<div class="container red lighten-3">
		<div class="row" style="margin: 0px">
			<div class="col s3">
				<div class="blue game_div z-depth-3">
					<h5>Cool People Only</h5>
					<p style="font-size: 125%">Current Players:</p>
					<p class="player">MilkMan24</p>
					<p class="player">LuckyGuy13</p>
					<p class="player">JoeShmoe</p>
					<p class="player">Erik</p>
				</div>
				
			</div>
			<div class="col s3">
				<div class="blue game_div z-depth-2">
					<h5>Cool People Suck</h5>
					<p style="font-size: 125%">Current Players:</p>
					<p class="player">MilkMan22</p>
				</div>
				
			</div>
			<div class="col s3">
				<div class="blue game_div">
					<h5>Henry's Lobby</h5>
					<p style="font-size: 125%">Current Players:</p>
					<p class="player">HenryTheHenry</p>
					<p class="player">NotHenry</p>
					<p class="player">StillNotHenry</p>
					<p class="player">Erik</p>
					<p class="player">Guy123</p>
				</div>
				
			</div>
			<div class="col s3">
				<div class="blue game_div">
					<h5>Cool People Only</h5>
					<p style="font-size: 125%">Current Players:</p>
					<p class="player">MilkMan24</p>
					<p class="player">LuckyGuy13</p>
					<p class="player">JoeShmoe</p>
					<p class="player">Erik</p>
				</div>
				
			</div>	
		</div>

		<div class="row">
			<a class="waves-effect waves-light btn green accent-3">Create Lobby</a>
		</div>
		<div class="row">
			<div id="player_bank" class="col s4 offset-s1 yellow">
				<h5>In Main Lobby</h5>
				<div id="players"></div>
			</div>
			<div id="current_user" class="col s5 offset-s1 light-green accent-1">
		       <form>
		          <div class="row" style="margin: 0px">
		             <div class="input-field col s6">
		                <input placeholder="Username" id="user_name" type="text" class="validate">
		          	 </div>
		          	 <div class="input-field col s6">
		            	<input  placeholder="Password" id="user_pass" type="text" class="validate">
		          	 </div>
		          </div>
		          <a id="sign-in" class="waves-effect waves-dark btn green accent-3">Register</a>
		       </form>
			</div>
		</div>
		
	</div>
        
	<script src="https://code.jquery.com/jquery.js"></script>		
	<script src="https://www.gstatic.com/firebasejs/4.7.0/firebase.js"></script>
	<script>
	  // Initialize Firebase
	  var config = {
	    apiKey: "AIzaSyAJoEFrLqa_WPI4S6SeVRsVdPBlAAbZ5Eg",
	    authDomain: "buy-game-d14de.firebaseapp.com",
	    databaseURL: "https://buy-game-d14de.firebaseio.com",
	    projectId: "buy-game-d14de",
	    storageBucket: "buy-game-d14de.appspot.com",
	    messagingSenderId: "356316304251"
	  };
	  firebase.initializeApp(config);
	  
	  var database = firebase.database();
	  checkStorage();
	  var players = [];

	  database.ref().on('value', function(snapshot) {
	  	console.log(snapshot.val());

	  	players = snapshot.val().online_users;
		
		// Checks data from firebase db 
		// TODO - err handle if cannot connect to db
		console.log(players);
	  	if( players !== undefined) {
	  		display(players);
	  	} else {
	  		players = [];
	  		// noConnectionDisplay();
	  	}
	  	
	  });

	  function display(array) {
	  	$("#players").empty();

	  	$(array).each( function(i) {	
	  		var p = $("<p>");
	  		p.html(array[i]);
	  		$("#players").append(p);	
	  	});
	  }

	  function noConnectionDisplay() {
	  	$("#players").empty();

	  	var txt = $("<p>");
	  	txt.html("Lost connection to database");
	  	$("#players").append(txt);
	  }

	  function checkStorage() {
	  	console.log(sessionStorage);
	  	if( typeof(sessionStorage) !== "undefined") displayAccount();
	  }

	  function getData(name, callBack) {
	  	database.ref('users/' + name).once('value').then(function(snapshot) {
	  		var obj = snapshot.val();
	  		callBack(obj);
	  	})
	  }

	  function signIn(name, pass) {
	  	/* two routes
	  		check if entered username is already in db
	  			if no, insert into user/pass into db

	  			if yes, check if user/pass is correct 
	  				then sign in append to online player 	*/

	  	getData(name, function(data) {
	  		console.log(data);

	  		if (data === null) firebaseSet(name, pass);
			else if(name === data.username && pass === data.password) {
	  			saveSession(data);
	  		} 
	  	});
	  }

	  // inserts new users to database with starting stats
	  function firebaseSet(name, pass) {
	  	database.ref('users/' + name).set({
	  	  username: name,
	  	  password: pass,
	  	  completed_games: 0,
	  	  games_won: 0
	  	});

	  	getData(name, function(data){
	  		saveSession(data);
	  	});  	
	  }

	  function displayAccount() {
	  	$("#current_user").empty();
	  	var name = $("<h5 class='header'>").html(sessionStorage.username);
	  	var icon = $("<i class='material-icons header'>clear</i>");
	  	var totalGames = $("<p>").html("Games Completed: "  + sessionStorage.completed_games);
	  	var gamesWon = $("<p>").html("Games won: " + sessionStorage.games_won);
	  	$("#current_user").append(name);
	  	$("#current_user").append(icon);
	  	$("#current_user").append(totalGames);
	  	$("#current_user").append(gamesWon);
	  }

	  function saveSession(user) {
	  	sessionStorage.username = user.username;
	  	sessionStorage.completed_games = user.completed_games;
	  	sessionStorage.games_won = user.games_won; 

	  	players.push(user.username);
	  	database.ref('online_users').set(players);
	  }

	  $(document).ready(function() {
	  	$("#sign-in").on("click", function() {
	  		event.preventDefault();

	  		var userName = $("#user_name").val().trim();
	  		var userPass = $("#user_pass").val();
	  		// console.log(userName);

	  		signIn(userName, userPass);
	  	});
	  });
	</script>	

</body>
</html>